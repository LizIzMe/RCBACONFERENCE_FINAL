@model RCBACONFERENCE.Models.CheckEthicsViewModel

@{
    Layout = "_LayoutChief";
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold text-primary">Check Ethics Certificates</h1>
        <form method="get" asp-action="CheckEthics" id="filterForm" class="d-flex">
            <select id="researchEventId" name="researchEventId" class="form-select me-2" onchange="document.getElementById('filterForm').submit();">
                <option value="">View All</option>
                @foreach (var eventItem in Model.ResearchEvents)
                {
                    string isSelected = Model.SelectedResearchEventId == eventItem.ResearchEventId ? "selected" : "";
                    @Html.Raw($"<option value=\"{eventItem.ResearchEventId}\" {isSelected}>{eventItem.DisplayText}</option>")
                }
            </select>
        </form>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>@TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle-fill me-2"></i>@TempData["ErrorMessage"]
        </div>
    }

    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Ethics ID</th>
                    <th>Research Title</th>
                    <th>Authors</th>
                    <th>Event Name</th>
                    <th>Status</th>
                    <th>Comment</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.EthicsCertificates.Any())
                {
                    @foreach (var certificate in Model.EthicsCertificates)
                    {
                        <tr class="align-middle">
                            <form method="post" asp-action="UpdateEthicsStatus" asp-controller="Chief">
                                <td class="fw-bold">@certificate.EthicsID</td>
                                <td>@certificate.ResearchTitle</td>
                                <td>
                                    <div>@certificate.Author</div>
                                    @if (!string.IsNullOrWhiteSpace(certificate.CoAuthors))
                                    {
                                        <div>@Html.Raw(certificate.CoAuthors.Replace(",", "<br />"))</div>
                                    }
                                </td>
                                <td>@certificate.EventName</td>
                                <td>
                                    <select name="Status" class="form-select form-select-sm" @(certificate.Status == "Approved" ? "disabled" : "")>
                                        @Html.Raw($"<option value=\"Pending\" {(certificate.Status == "Pending" ? "selected" : "")}>Pending</option>")
                                        @Html.Raw($"<option value=\"Approved\" {(certificate.Status == "Approved" ? "selected" : "")}>Approved</option>")
                                        @Html.Raw($"<option value=\"Rejected\" {(certificate.Status == "Rejected" ? "selected" : "")}>Rejected</option>")
                                    </select>
                                </td>
                                <td>
                                    <textarea name="Comment" class="form-control form-control-sm"
                                        @(certificate.Status != "Rejected" ? "readonly" : "")>@certificate.Comment</textarea>
                                </td>
                                <td class="text-center">
                                    <input type="hidden" name="EthicsID" value="@certificate.EthicsID" />
                                    <button type="submit" class="btn btn-primary btn-sm me-2" @(certificate.Status == "Approved" ? "disabled" : "")>
                                        <i class="bi bi-save"></i> Update
                                    </button>
                                    <a asp-action="ViewEthicsCertificate" asp-route-id="@certificate.EthicsID" class="btn btn-info btn-sm" target="_blank">
                                        <i class="bi bi-file-earmark-pdf"></i> View
                                    </a>
                                </td>
                            </form>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center text-muted">No ethics certificates found.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const statusDropdowns = document.querySelectorAll('select[name="Status"]');
            statusDropdowns.forEach(dropdown => {
                dropdown.addEventListener('change', function () {
                    const commentBox = this.closest('tr').querySelector('textarea[name="Comment"]');
                    if (this.value === "Rejected") {
                        commentBox.removeAttribute('readonly');
                    } else {
                        commentBox.setAttribute('readonly', 'readonly');
                        commentBox.value = ""; // Clear the comment box when not rejected
                    }
                });
            });
        });
    </script>
}
