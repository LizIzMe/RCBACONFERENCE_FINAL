@model CheckReceiptsViewModel
@{
    Layout = "_LayoutChief";
}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold" style="color:#850000">Check Receipts</h1>
        <form method="get" asp-action="CheckReceipts" id="filterForm" class="d-flex">
            <select id="researchEventId" name="researchEventId" class="form-select me-2" onchange="document.getElementById('filterForm').submit();">
                <option value="">View All</option>
                @foreach (var eventItem in Model.ResearchEvents)
                {
                    string isSelected = Model.SelectedResearchEventId == eventItem.ResearchEventId ? "selected" : "";
                    @Html.Raw($"<option value=\"{eventItem.ResearchEventId}\" {isSelected}>{eventItem.DisplayText}</option>")
                }
            </select>
        </form>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>@TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle-fill me-2"></i>@TempData["ErrorMessage"]
        </div>
    }

    <div class="table-responsive bg-light" style="width:1300px; max-width:1300px; border-radius:12px; border: 1px solid #ddd; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);max-height:500px;overflow-y:auto">
        <table class="table table-hover align-middle">
            <thead class="table-header">
                <tr>
                    <th class="fw-bold">User ID</th>
                    <th class="fw-bold">Research Event</th>
                    <th class="fw-bold">Name</th>
                    <th class="fw-bold">Classification</th>
                    <th class="fw-bold">Reference</th>
                    <th class="fw-bold">Status</th>
                    <th class="fw-bold"> Comment</th>
                    <th class="text-center fw-bold">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Receipts.Any())
                {
                    @foreach (var receipt in Model.Receipts)
                    {
                        <tr class="align-middle">
                            <form method="post" asp-action="UpdateReceiptStatus" asp-controller="Chief">
                                <td class="fw-bold">@receipt.UserId</td>
                                <td>@receipt.ResearchEventId</td>
                                <td>@receipt.Name</td>
                                <td>@receipt.Classification</td>
                                <td>@receipt.ReferenceNumber</td>
                                <td>
                                    <select name="Status" class="form-select form-select-sm">
                                        @Html.Raw($"<option value=\"Pending\" {(receipt.Status == "Pending" ? "selected" : "")}>Pending</option>")
                                        @Html.Raw($"<option value=\"Approved\" {(receipt.Status == "Approved" ? "selected" : "")}>Approved</option>")
                                        @Html.Raw($"<option value=\"Rejected\" {(receipt.Status == "Rejected" ? "selected" : "")}>Rejected</option>")
                                    </select>
                                </td>
                                <td>
                                    <textarea name="Comment" class="form-control form-control-sm"
                                        @(receipt.Status != "Rejected" ? "readonly" : "")>@receipt.Comment</textarea>
                                </td>
                                <td class="text-center">
                                    <input type="hidden" name="UserId" value="@receipt.UserId" />
                                    <input type="hidden" name="ResearchEventId" value="@receipt.ResearchEventId" />
                                    <button type="submit" class="btn btn-primary btn-sm me-2">
                                        <i class="bi bi-save"></i> Update
                                    </button>
                                    <a asp-action="ViewReceipt" asp-route-userId="@receipt.UserId" asp-route-researchEventId="@receipt.ResearchEventId" class="btn btn-info btn-sm">
                                        <i class="bi bi-file-earmark-image"></i> View
                                    </a>
                                </td>
                            </form>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="8" class="text-center text-black">No receipts found.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
                document.addEventListener('DOMContentLoaded', function () {
            const statusDropdowns = document.querySelectorAll('select[name="Status"]');
            statusDropdowns.forEach(dropdown => {
                dropdown.addEventListener('change', function () {
                    const commentBox = this.closest('tr').querySelector('textarea[name="Comment"]');
                    if (this.value === "Rejected") {
                        commentBox.removeAttribute('readonly');
                    } else {
                        commentBox.setAttribute('readonly', 'readonly');
                        commentBox.value = ""; // Clear the comment box when not rejected
                    }
                });
            });
        });

    </script>
}
